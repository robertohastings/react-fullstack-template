CREATE DEFINER=`appusercrmadmin`@`%` PROCEDURE `postHost`(
	IN prm_nombre VARCHAR(300),
    IN prm_logo VARCHAR(255),
	IN prm_host VARCHAR(100)
)
BEGIN
    DECLARE idEmpresa BIGINT;
    DECLARE idUsuario INT;
    DECLARE lorem VARCHAR(800);
	-- DECLARE EXIT HANDLER FOR SQLEXCEPTION
    -- BEGIN
        -- ROLLBACK;
        -- Opcional: Puedes agregar aquí un mensaje de error personalizado
        -- SELECT 'OCURRIÓ UN ERROR', ERROR_MESSAGE();
        
    -- END;        
	
	/*ALTA EN EMPRESAS*/

    SET lorem = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.';
        
    START TRANSACTION;
    
    INSERT INTO empresas (nombre, logo, host) VALUES (prm_nombre, prm_logo, prm_host);
    SET idEmpresa = last_insert_id();

	/*ALTA DE HOST*/
	IF NOT EXISTS(
		SELECT 1 
        FROM hosts H
        WHERE H.host = prm_host
    ) 
    THEN 
		INSERT INTO hosts (host, id_empresa) VALUES (prm_host, idEmpresa);
	ELSE 
		UPDATE hosts SET id_empresa = idEmpresa WHERE host = prm_host;
	END IF;
    -- SELECT 'EMPRESA';
    
    /*ALTA DE LANDING PAGE*/    
    INSERT INTO landingPage (	id_empresa, quienes_somos, servicios, productos, 
								mostrar_quienes_somos, mostrar_productos, mostrar_servicios, mostrar_contactanos, mostrar_sitioEnMantenimiento,
                                mostrar_landingPage, mostrar_carritoDeCompras
							)
		VALUES (idEmpresa, lorem, lorem, lorem, 1, 1, 1, 1, 1, 0, 0);
    
    /*ALTA DE USUARIO MASTER*/
    INSERT INTO usuarios (id_empresa, email, nombre, apellidos, celular, imagen, password, fecha_nacimiento, fecha_creacion, fecha_actualizacion)
    SELECT idEmpresa, U.email, U.nombre, U.apellidos, U.celular, U.imagen, U.password, U.fecha_nacimiento, current_timestamp(), current_timestamp()
    FROM usuarios U
    WHERE U.id_usuario = 1 AND U.id_empresa = 1;
    
    SET idUsuario = last_insert_id();
    
    /*ALTA DE DIRECCION*/
    INSERT INTO direcciones (id_empresa, id_direccion_tipo_identidad, identidad, direccion_por_defecto, direccion, calle, numero, colonia, ciudad, estado, pais, codigo_postal, fecha_creacion, fecha_actualizacion)
		VALUES (idEmpresa, 1, 1, 1, 'Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet', 'Lorem ipsum', 'Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet', 
			'Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet', 'Lorem', current_timestamp(), current_timestamp());
        
    /*ALTA DE FORMAS DE PAGO*/
    /*/Efectivo*/
    INSERT INTO formas_de_pago (id_empresa, descripcion, informacion_adicional, activo)
    SELECT idEmpresa, F.descripcion, '', 1 FROM formas_de_pago F WHERE F.id_empresa = 1 AND F.id_forma_de_pago = 1; 
    /*/Tarjeta contra entrega*/
    INSERT INTO formas_de_pago (id_empresa, descripcion, informacion_adicional, activo)
    SELECT idEmpresa, F.descripcion, '', 0 FROM formas_de_pago F WHERE F.id_empresa = 1 AND F.id_forma_de_pago = 2;     
    /*/Deposito*/
    INSERT INTO formas_de_pago (id_empresa, descripcion, informacion_adicional, activo)
    SELECT idEmpresa, F.descripcion, '', 1 FROM formas_de_pago F WHERE F.id_empresa = 1 AND F.id_forma_de_pago = 3;   
    /*/Transferencia*/
    INSERT INTO formas_de_pago (id_empresa, descripcion, informacion_adicional, activo)
    SELECT idEmpresa, F.descripcion, '', 1 FROM formas_de_pago F WHERE F.id_empresa = 1 AND F.id_forma_de_pago = 4; 
    /*/Pago en Linea*/
    INSERT INTO formas_de_pago (id_empresa, descripcion, informacion_adicional, activo)
    SELECT idEmpresa, F.descripcion, '', 0 FROM formas_de_pago F WHERE F.id_empresa = 1 AND F.id_forma_de_pago = 5;         
    /*/Linea de Crédito*/
    INSERT INTO formas_de_pago (id_empresa, descripcion, informacion_adicional, activo)
    SELECT idEmpresa, F.descripcion, '', 0 FROM formas_de_pago F WHERE F.id_empresa = 1 AND F.id_forma_de_pago = 6;  
    -- SELECT 'FORMAS DE PAGO';
    
    /*AGREGAR DATOS EN TABLA: pedido_estatus*/
    INSERT INTO pedido_estatus (id_empresa, descripcion, orden)
    SELECT idEmpresa, descripcion, orden FROM pedido_estatus WHERE id_empresa = 1;
    
    -- MENU Y ROLES
    INSERT INTO procMenu (id_empresa, id_padre, nombre, orden, activo, linkTo, icono, soloLanding)
    SELECT idEmpresa, P.id_padre, P.nombre, P.orden, P.activo, P.linkTo, P.icono, P.soloLanding FROM procMenu P WHERE P.id_empresa = 1;
    
    INSERT roles (id_empresa, nombre, fecha_creacion, fecha_actualizacion)
    SELECT idEmpresa, R.nombre, CURDATE(), CURDATE() FROM roles R WHERE R.id_empresa = 1;
    
    INSERT INTO rol_menu (id_empresa, id_rol, id_procMenu)
    SELECT idEmpresa, id_rol, id_procMenu FROM rol_menu WHERE id_empresa = 1;
    
	INSERT INTO usuario_rol (id_empresa, id_usuario, id_rol)
    SELECT idEmpresa, UR.id_usuario, UR.id_rol FROM usuario_rol UR WHERE UR.id_empresa = 1;
    
    -- AGENDA
    INSERT INTO jornada_laboral (id_empresa, dia_semana, hora_inicio, hora_fin, duracion_cita)
    SELECT idEmpresa, JL.dia_semana, JL.hora_inicio, JL.hora_fin, JL.duracion_cita FROM jornada_laboral JL WHERE JL.id_empresa = 1;
    
    INSERT INTO agenda_estatus (id_empresa, descripcion)
    SELECT idEmpresa, descripcion FROM agenda_estatus WHERE id_empresa = 1;
    
    -- COMMIT;
END

CREATE DEFINER=`appusercrmadmin`@`%` PROCEDURE `getProductosByCategoria`(
	IN prm_id_empresa INT,
    IN prm_id_categoria INT
)
BEGIN
	SELECT 	P.id_producto, P.nombre, P.descripcion, 
			P.id_proveedor, PR.nombre AS Proveedor,
            P.id_categoria, C.nombre AS categoria,
            P.precio,
            P.precio_promocion,
            P.costo,
            P.image1,
            P.image2,
            P.image3,
            P.existencia,
            P.fecha_creacion,
            P.fecha_actualizacion
    FROM productos P
    INNER JOIN categorias C ON C.id_empresa = P.id_empresa AND C.id_categoria = P.id_categoria
    INNER JOIN proveedores PR ON PR.id_empresa = P.id_empresa AND PR.id_proveedor = P.id_proveedor
    WHERE P.id_empresa = prm_id_empresa AND P.id_categoria = prm_id_categoria AND P.Activo = 1;
END